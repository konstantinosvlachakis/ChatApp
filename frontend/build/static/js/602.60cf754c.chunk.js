"use strict";(self.webpackChunkclient=self.webpackChunkclient||[]).push([[602],{2538:(e,s,t)=>{t.d(s,{cn:()=>a});var l=t(8387),r=t(9359);function a(){for(var e=arguments.length,s=new Array(e),t=0;t<e;t++)s[t]=arguments[t];return(0,r.QP)((0,l.A)(s))}},8602:(e,s,t)=>{t.r(s),t.d(s,{default:()=>E});var l=t(5043),r=t(9346),a=t(3216),n=t(6896),o=t(6213),i=t(9953);var c=t(579);const d=function(e){let{onSelectConversation:s,activeConversationId:t}=e;const[r,d]=(0,l.useState)([]),[u,m]=(0,l.useState)(null),[g,x]=(0,l.useState)(!0),{user:h}=(0,n.J)(),f=(0,a.Zp)();return(0,l.useEffect)((()=>{(async(e,s,t)=>{const l=sessionStorage.getItem("accessToken");if(!l)return s("Authentication token is missing. Please log in."),void t("/login");try{e((await o.A.get(i.C+"/api/conversations/",{headers:{Authorization:`Bearer ${l}`},withCredentials:!0})).data),console.log("Conversations fetched successfully")}catch(u){var r,a,n;o.A.isAxiosError(u)?401===(null===(r=u.response)||void 0===r?void 0:r.status)?(sessionStorage.removeItem("accessToken"),t("/login")):s((null===(a=u.response)||void 0===a||null===(n=a.data)||void 0===n?void 0:n.detail)||"Failed to fetch conversations"):s("An unexpected error occurred."),console.error("Error fetching conversations:",u)}})(d,m,f).finally((()=>x(!1)))}),[f]),g?(0,c.jsx)("div",{children:"Loading conversations..."}):u?(0,c.jsx)("div",{className:"text-red-500",children:u}):(0,c.jsx)("div",{className:"overflow-y-auto",children:r.map((e=>{var l,r;const a=(null===(l=e.sender)||void 0===l?void 0:l.username)===(null===h||void 0===h?void 0:h.username)?e.receiver:e.sender,n=i.i+((null===a||void 0===a?void 0:a.profile_image_url)||"")||"https://via.placeholder.com/50";return(0,c.jsxs)("div",{className:"flex items-center p-2 cursor-pointer "+(t===e.id?"bg-gray-300":"hover:bg-gray-200"),onClick:()=>s(e),children:[(0,c.jsx)("img",{src:n,alt:(null===a||void 0===a?void 0:a.username)||"Participant",className:"w-12 h-12 rounded-full mr-3"}),(0,c.jsxs)("div",{className:"flex-1",children:[(0,c.jsx)("p",{className:"font-semibold",children:(null===a||void 0===a?void 0:a.username)||"Unknown Participant"}),(0,c.jsxs)("p",{className:"text-sm text-gray-500",children:[(null===(r=e.last_message)||void 0===r?void 0:r.text)||"No messages yet"," ",(0,c.jsxs)("span",{className:"text-gray-400",children:["(",new Date(e.updated_at).toLocaleString(),")"]})]})]})]},e.id)}))})};const u=function(e){let{onSelectConversation:s,activeConversationId:t}=e;return(0,c.jsxs)("div",{className:"w-1/4 h-screen bg-white shadow-lg border-r flex flex-col",children:[(0,c.jsx)("div",{className:"p-4 border-b",children:(0,c.jsx)("input",{type:"text",placeholder:"Search",className:"w-full p-2 rounded-full border border-gray-300 outline-none focus:ring-2 focus:ring-blue-500"})}),(0,c.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,c.jsx)(d,{onSelectConversation:s,activeConversationId:t})})]})},m=e=>{var s;let{conversation:t}=e;const{user:l}=(0,n.J)(),r=(null===(s=t.sender)||void 0===s?void 0:s.username)===(null===l||void 0===l?void 0:l.username)?t.receiver:t.sender;return(0,c.jsxs)("div",{className:"p-4 border-b bg-white flex items-center",children:[(0,c.jsx)("img",{src:i.i+r.profile_image_url,alt:r.username,className:"w-10 h-10 rounded-full mr-3"}),(0,c.jsx)("h2",{className:"font-semibold text-lg",children:r.username})]})},g=e=>{let{messages:s,userId:t,onDeleteMessage:r}=e;const[a,n]=(0,l.useState)(null),o=(0,l.useRef)(null);return(0,l.useEffect)((()=>{var e;null===(e=o.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})}),[s]),(0,c.jsxs)("div",{className:"flex-1 p-4 bg-gray-50 flex flex-col overflow-y-auto scroll-container",children:[s.length>0?s.map(((e,s)=>{var l;const o=e.attachment_url||e.attachment,i=!!o,d=(null===(l=e.sender)||void 0===l?void 0:l.id)===t;return(0,c.jsxs)("div",{className:`relative max-w-fit ${!i&&d?"bg-blue-100":""} ${i?"":"px-4 py-2"} mb-2 rounded-full ${d?"self-end":"bg-gray-200 self-start"}`,children:[d&&(0,c.jsxs)("div",{className:"absolute -left-6 top-1/2 transform -translate-y-1/2 z-20 group",children:[(0,c.jsxs)("button",{className:"text-gray-500 hover:text-gray-700 focus:outline-none",onClick:()=>(e=>{n((s=>s===e?null:e))})(s),children:[(0,c.jsx)("span",{className:"inline-block w-1.5 h-1.5 bg-gray-500 rounded-full"}),(0,c.jsx)("span",{className:"inline-block w-1.5 h-1.5 bg-gray-500 rounded-full mx-0.5"}),(0,c.jsx)("span",{className:"inline-block w-1.5 h-1.5 bg-gray-500 rounded-full"})]}),a===s&&(0,c.jsx)("div",{className:"absolute right-full top-0 mr-2 mt-0 bg-white border shadow-lg rounded z-50 group-hover:block",onMouseLeave:()=>n(null),onMouseEnter:()=>n(s),children:(0,c.jsx)("button",{onClick:()=>{r(e.id),n(null)},className:"block px-4 py-2 text-sm text-red-500 hover:bg-red-100",children:"Delete"})})]}),i?/\.(jpeg|jpg|png|gif|mp4|webm)$/i.test(o)?(0,c.jsx)("div",{className:"w-40 h-40 rounded-full overflow-hidden bg-gray-200 flex items-center justify-center",children:o.match(/\.(mp4|webm)$/i)?(0,c.jsx)("video",{src:o,controls:!0,className:"object-cover w-full h-full"}):(0,c.jsx)("img",{src:o,alt:"Attachment",className:"object-cover w-full h-full"})}):(0,c.jsx)("a",{href:o,target:"_blank",rel:"noopener noreferrer",className:"text-blue-500 underline",children:"\ud83d\udcce View Attachment"}):(0,c.jsx)("p",{children:e.text||"No content available"})]},s)})):(0,c.jsx)("div",{className:"text-gray-500",children:"No messages yet!"}),(0,c.jsx)("div",{ref:o})]})};t(2394);const x=e=>{let{onEmojiSelect:s}=e;const t=(0,l.useRef)(null);return l.useEffect((()=>{const e=t.current,l=e=>{s&&s(e.detail.unicode)};return e&&e.addEventListener("emoji-click",l),()=>{e&&e.removeEventListener("emoji-click",l)}}),[s]),(0,c.jsx)("emoji-picker",{ref:t})};var h=t(3875),f=t(5874),v=t(4219);const p=e=>{let{onSendMessage:s,currentUser:t,onMessageReceived:r}=e;const[a,n]=(0,l.useState)(""),[o,i]=(0,l.useState)(!1),[d,u]=(0,l.useState)(null),[m,g]=(0,l.useState)(null),p=(0,l.useRef)(null),b=(0,l.useRef)(null);return(0,c.jsxs)("div",{className:"p-4 border-t bg-white flex items-center relative",children:[(0,c.jsx)("button",{onClick:()=>i((e=>!e)),className:"mr-2",children:"\ud83d\ude0a"}),o&&(0,c.jsx)("div",{ref:p,className:"absolute bottom-16 left-0 z-50",children:(0,c.jsx)(x,{onEmojiSelect:e=>n((s=>s+e))})}),(0,c.jsxs)("div",{className:"relative flex w-1/2 items-center",children:[(0,c.jsxs)("div",{className:"flex items-center w-full p-2 border border-gray-300 rounded-lg",children:[d&&(0,c.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,c.jsx)("img",{src:d,alt:"Preview",className:"h-10 w-10 object-cover rounded"}),(0,c.jsx)("button",{onClick:()=>{d&&URL.revokeObjectURL(d),u(null),g(null)},className:"text-red-500 text-sm",children:"\u2715"})]}),(0,c.jsx)("input",{type:"text",value:a,onChange:e=>n(e.target.value),placeholder:"Type your message...",className:"w-full outline-none"})]}),(0,c.jsx)(h.A,{className:"absolute right-10 text-gray-500 cursor-pointer",onClick:()=>b.current.click()}),(0,c.jsx)("input",{type:"file",ref:b,style:{display:"none"},onChange:e=>{const s=e.target.files[0];if(s){if(s.type.startsWith("image/")||s.type.startsWith("video/")){const e=URL.createObjectURL(s);u(e),g(s)}else alert("Please select a valid image or video file.");b.current.value=null}}}),(0,c.jsx)(v.A,{className:"absolute right-2 text-gray-500 cursor-pointer"})]}),(0,c.jsx)("button",{type:"button",className:"ml-3 text-blue-500",onClick:()=>{a.trim()||m?(s(a,m,d),n(""),d&&URL.revokeObjectURL(d),u(null),g(null)):alert("Please enter a message or attach a file.")},children:(0,c.jsx)(f.A,{})})]})},b=e=>{let{conversation:s,user:t}=e;const[r,a]=(0,l.useState)(s.messages||[]),[n,d]=(0,l.useState)(!1),u=(0,l.useRef)(null),x=(0,l.useRef)(null);(0,l.useEffect)((()=>{const e=`ws://localhost:8000/ws/socket-server/${s.id}/`;return u.current=new WebSocket(e),u.current.onopen=()=>{console.log("WebSocket connection established.")},u.current.onmessage=e=>{const s=JSON.parse(e.data);if(console.log("WebSocket message received:",s),"chat"===s.type){if(s.senderId===t.user_id)return;a((e=>[...e,{id:s.id,text:s.message,sender:{username:s.sender},timestamp:(new Date).toISOString()}]))}else if("deleteMessage"===s.type){const e=s.messageId;a((s=>s.filter((s=>s.id!==e))))}else"user_typing"===s.type?s.sender!==t.username&&(d(!0),x.current&&clearTimeout(x.current),x.current=setTimeout((()=>{d(!1)}),3e3)):"user_stopped_typing"===s.type&&s.sender!==t.username&&d(!1)},u.current.onerror=e=>{console.error("WebSocket error:",e)},u.current.onclose=()=>{console.log("WebSocket connection closed.")},()=>{u.current.close(),x.current&&clearTimeout(x.current)}}),[s.id,t.username]);return(0,c.jsxs)("div",{className:"flex flex-col h-screen overflow-y-hidden",children:[(0,c.jsx)(m,{conversation:s}),(0,c.jsx)(g,{messages:r,userId:t.user_id,onDeleteMessage:async e=>{try{a((s=>s.filter((s=>s.id!==e)))),await(async e=>{try{return await o.A.delete(i.C+`/api/messages/${e}/delete/`,{headers:{Authorization:`Bearer ${sessionStorage.getItem("accessToken")}`}}),{messageId:e}}catch(s){throw console.error("Error deleting message:",s),s}})(e),u.current.send(JSON.stringify({type:"deleteMessage",messageId:e}))}catch(s){console.error("Failed to delete message:",s)}}}),n&&(0,c.jsx)("div",{className:"text-gray-500 text-sm p-2",children:"The other user is typing..."}),(0,c.jsx)(p,{onSendMessage:async(e,l,r)=>{const n=new FormData;e.trim()&&n.append("text",e),l&&n.append("attachment",l);const c={id:Date.now(),text:e.trim()||null,sender:{id:t.user_id,username:t.username},timestamp:(new Date).toISOString(),attachment:null,attachmentUrl:r||null};a((e=>[...e,c]));try{const e=(await o.A.post(i.C+`/api/conversations/${s.id}/messages/`,n,{headers:{Authorization:`Bearer ${sessionStorage.getItem("accessToken")}`,"Content-Type":"multipart/form-data"}})).data;u.current.send(JSON.stringify({type:"chat",id:e.id,message:e.text,sender:t.username,senderId:t.user_id}))}catch(d){console.error("Error sending message:",d),a((e=>e.filter((e=>e.id!==c.id))))}},onTyping:()=>{u.current.send(JSON.stringify({type:"user_typing",sender:t.username}))},onStopTyping:()=>{u.current.send(JSON.stringify({type:"user_stopped_typing",sender:t.username}))}})]})};var j=t(4449),y=t(3438),N=t(7392),w=t(2538);const S=function(e){let{children:s,className:t}=e;return(0,c.jsx)("h1",{className:(0,w.cn)("font-alegreyaSans-black text-primary text-4xl",t),children:s})};function k(e){let{title:s,children:t,open:l=!1,setOpen:r,className:a,cypressTag:n,hideClose:o=!1}=e;return(0,c.jsx)("div",{children:(0,c.jsx)(j.A,{open:l,"data-cy":n,onClose:()=>r(!1),"aria-labelledby":"modal-modal-title","aria-describedby":"modal-modal-description",className:"flex justify-center items-center",children:(0,c.jsxs)("div",{className:"relative text-primary",children:[!o&&(0,c.jsx)(N.A,{onClick:()=>r(!1),className:"absolute top-5 right-5 text-pr z-20",children:(0,c.jsx)(y.A,{className:"text-4xl"})}),(0,c.jsxs)("div",{className:(0,w.cn)("over bg-white w-fit min-w-[450px] min-h-5 p-5 max-w-[1200px] m-5 shadow-md overflow-auto tall:max-w-[auto] tall:max-h-[500px]",a),children:[s&&(0,c.jsx)(S,{className:"m-0",children:s}),t]})]})})})}var C=t(324);const I=new(t(2907).QueryClient)({defaultOptions:{queries:{useErrorBoundary:!0,refetchOnWindowFocus:!1,retry:!1}}}),A=async e=>{const s=sessionStorage.getItem("accessToken"),t=await o.A.patch(i.C+"/api/profile/edit/",e,{headers:{Authorization:`Bearer ${s}`}});return console.log(t.data),t.data};var D=t(7332);const _=e=>{let{onImageDrop:s,initialImage:t}=e;const[r,a]=(0,l.useState)(t),[n,o]=(0,l.useState)(!1),[i,d]=(0,l.useState)(!1);return(0,c.jsxs)("div",{className:"relative w-40 h-40 rounded-full overflow-hidden border-4 "+(n?"border-blue-500":"border-gray-400"),onDragOver:e=>{e.preventDefault(),o(!0)},onDragLeave:e=>{e.preventDefault(),o(!1)},onDrop:e=>{e.preventDefault(),o(!1);const t=e.dataTransfer.files[0];if(t&&t.type.startsWith("image/")){const e=URL.createObjectURL(t);a(e),s&&s(t)}else alert("Please drop a valid image file.")},children:[(0,c.jsx)("img",{src:t,alt:"Profile",className:"absolute top-0 left-0 w-full h-full object-cover cursor-pointer",onClick:()=>d(!0)}),n&&(0,c.jsx)("div",{className:"absolute top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center",children:(0,c.jsx)("p",{className:"text-white text-lg font-semibold",children:"Drop Here"})}),(0,c.jsx)("input",{id:"file-input",type:"file",accept:"image/*",className:"hidden",onChange:e=>{const t=e.target.files[0];if(t&&t.type.startsWith("image/")){const e=URL.createObjectURL(t);a(e),s&&s(t)}else alert("Please select a valid image file.")}}),i&&(0,c.jsxs)("div",{className:"fixed top-0 left-0 w-full h-full bg-black bg-opacity-75 flex items-center justify-center z-50",children:[(0,c.jsx)("img",{src:t,alt:"Zoomed",className:"w-auto max-w-full h-auto max-h-full"}),(0,c.jsx)("button",{className:"absolute top-4 right-4 text-white text-xl font-bold",onClick:()=>d(!1),children:"\u2715"})]}),(0,c.jsx)("button",{className:"absolute bottom-2 right-2 bg-blue-500 text-white p-2 rounded-full shadow-md",onClick:()=>{document.getElementById("file-input").click()},children:"\ud83d\udce4"})]})},E=()=>{const[e,s]=(0,l.useState)({}),[t,n]=(0,l.useState)(null),[o,d]=(0,l.useState)(!1),[m,g]=(0,l.useState)(""),[x,h]=(0,l.useState)(null),f=(e=>{let{config:s}=e;return(0,C.n)({mutationKey:["editProfile"],mutationFn:A,onMutate:async e=>{const s=I.getQueryData(["userProfile"]);return I.setQueryData(["userProfile"],(s=>({...s,...e}))),{previousUserProfile:s}},onError:(e,s,t)=>{null!==t&&void 0!==t&&t.previousUserProfile&&I.setQueryData(["userProfile"],t.previousUserProfile)},onSuccess:()=>{I.invalidateQueries(["userProfile"])},...s})})({}),v=(0,a.Zp)(),p=i.C+e.profile_image_url;(0,l.useEffect)((()=>{(0,r.l)(s,(()=>{}),n,v)}),[v]);const j=async()=>{try{await f.mutateAsync({username:m}),s((e=>({...e,username:m}))),d(!1)}catch(e){n(e.message)}},y=[{label:"Name",value:e.username||"John Doe"},{label:"Date of Birth",value:e.date_of_birth||"Not provided"},{label:"Location",value:e.location||"Not specified"},{label:"Native Language",value:e.native_language||"English"},{label:"Languages Practicing",value:e.languages||"Spanish, French"},{label:"Learning Goal",value:e.learningGoal||"Become fluent for travel"},{label:"Date Joined",value:e.dateJoined||"January 1, 2023"}];return(0,c.jsxs)("div",{className:"flex min-h-screen bg-gray-100",children:[(0,c.jsx)(u,{onSelectConversation:h,activeConversationId:null===x||void 0===x?void 0:x.id}),(0,c.jsx)("div",{className:"flex-1 relative",children:x?(0,c.jsxs)("div",{className:"flex flex-col h-full",children:[(0,c.jsx)("div",{className:"absolute top-4 right-4 flex items-center",children:(0,c.jsx)(N.A,{color:"primary","aria-label":"Back to Profile",onClick:()=>h(null),children:(0,c.jsx)(D.A,{})})}),(0,c.jsx)(b,{conversation:x,user:e})]}):(0,c.jsxs)("div",{className:"flex flex-col items-center space-y-6 p-4 w-full h-full",children:[(0,c.jsx)("div",{className:"absolute top-5 right-5",children:(0,c.jsx)("button",{className:"bg-red-500 text-white py-1 px-4 rounded-full",onClick:()=>{sessionStorage.removeItem("accessToken"),v("/login")},children:"Sign Out"})}),(0,c.jsx)(_,{onImageDrop:e=>console.log("Image dropped:",e),initialImage:p}),(0,c.jsx)("button",{className:"bg-blue-500 text-white py-1 px-4 rounded-full",onClick:()=>d(!0),children:"Edit"}),o&&(0,c.jsxs)(k,{open:o,setOpen:d,children:[(0,c.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"Edit Name"}),(0,c.jsx)("input",{type:"text",value:m,onChange:e=>g(e.target.value),className:"w-full p-2 mb-4 border rounded",placeholder:"Enter new Name"}),(0,c.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,c.jsx)("button",{className:"bg-gray-300 text-gray-800 py-1 px-4 rounded",onClick:()=>d(!1),children:"Close"}),(0,c.jsx)("button",{className:"bg-blue-500 text-white py-1 px-4 rounded",onClick:j,children:"Save"})]})]}),(0,c.jsxs)("div",{className:"w-full max-w-lg p-4 rounded-lg bg-gray-50 space-y-4",children:[y.map(((e,s)=>{let{label:t,value:l}=e;return(0,c.jsxs)("div",{children:[(0,c.jsxs)("h2",{className:"text-lg font-semibold text-gray-600",children:[t,":"]}),(0,c.jsx)("p",{className:"text-gray-800",children:l}),s<y.length-1&&(0,c.jsx)("hr",{className:"border-gray-200"})]},s)})),t&&(0,c.jsx)("div",{className:"mt-4 text-red-500",children:t})]})]})})]})}}}]);
//# sourceMappingURL=602.60cf754c.chunk.js.map