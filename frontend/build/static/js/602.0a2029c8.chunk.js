"use strict";(self.webpackChunkclient=self.webpackChunkclient||[]).push([[602],{2538:(e,t,s)=>{s.d(t,{cn:()=>a});var r=s(8387),l=s(9359);function a(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return(0,l.QP)((0,r.A)(t))}},8602:(e,t,s)=>{s.r(t),s.d(t,{default:()=>E});var r=s(5043),l=s(9346),a=s(3216),n=s(6896),o=s(6213),i=s(9953);var c=s(579);const d=function(e){let{onSelectConversation:t,activeConversationId:s}=e;const[l,d]=(0,r.useState)([]),[u,m]=(0,r.useState)(null),[g,h]=(0,r.useState)(!0),{user:x}=(0,n.J)(),f=(0,a.Zp)();return(0,r.useEffect)((()=>{(async(e,t,s)=>{const r=sessionStorage.getItem("accessToken");if(!r)return t("Authentication token is missing. Please log in."),void s("/login");try{e((await o.A.get(i.C+"/api/conversations/",{headers:{Authorization:`Bearer ${r}`},withCredentials:!0})).data),console.log("Conversations fetched successfully")}catch(u){var l,a,n;o.A.isAxiosError(u)?401===(null===(l=u.response)||void 0===l?void 0:l.status)?(sessionStorage.removeItem("accessToken"),s("/login")):t((null===(a=u.response)||void 0===a||null===(n=a.data)||void 0===n?void 0:n.detail)||"Failed to fetch conversations"):t("An unexpected error occurred."),console.error("Error fetching conversations:",u)}})(d,m,f).finally((()=>h(!1)))}),[f]),g?(0,c.jsx)("div",{children:"Loading conversations..."}):u?(0,c.jsx)("div",{className:"text-red-500",children:u}):(0,c.jsx)("div",{className:"overflow-y-auto",children:l.map((e=>{var r,l;const a=(null===(r=e.sender)||void 0===r?void 0:r.username)===(null===x||void 0===x?void 0:x.username)?e.receiver:e.sender;console.log(i.i),console.log(a.profile_image_url);const n=i.i+((null===a||void 0===a?void 0:a.profile_image_url)||"")||"https://via.placeholder.com/50";return(0,c.jsxs)("div",{className:"flex items-center p-2 cursor-pointer "+(s===e.id?"bg-gray-300":"hover:bg-gray-200"),onClick:()=>t(e),children:[(0,c.jsx)("img",{src:n,alt:(null===a||void 0===a?void 0:a.username)||"Participant",className:"w-12 h-12 rounded-full mr-3"}),(0,c.jsxs)("div",{className:"flex-1",children:[(0,c.jsx)("p",{className:"font-semibold",children:(null===a||void 0===a?void 0:a.username)||"Unknown Participant"}),(0,c.jsxs)("p",{className:"text-sm text-gray-500",children:[(null===(l=e.last_message)||void 0===l?void 0:l.text)||"No messages yet"," ",(0,c.jsxs)("span",{className:"text-gray-400",children:["(",new Date(e.updated_at).toLocaleString(),")"]})]})]})]},e.id)}))})};const u=function(e){let{onSelectConversation:t,activeConversationId:s}=e;return(0,c.jsxs)("div",{className:"w-1/4 h-screen bg-white shadow-lg border-r flex flex-col",children:[(0,c.jsx)("div",{className:"p-4 border-b",children:(0,c.jsx)("input",{type:"text",placeholder:"Search",className:"w-full p-2 rounded-full border border-gray-300 outline-none focus:ring-2 focus:ring-blue-500"})}),(0,c.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,c.jsx)(d,{onSelectConversation:t,activeConversationId:s})})]})},m=e=>{var t;let{conversation:s}=e;const{user:r}=(0,n.J)(),l=(null===(t=s.sender)||void 0===t?void 0:t.username)===(null===r||void 0===r?void 0:r.username)?s.receiver:s.sender;return(0,c.jsxs)("div",{className:"p-4 border-b bg-white flex items-center",children:[(0,c.jsx)("img",{src:i.i+l.profile_image_url,alt:l.username,className:"w-10 h-10 rounded-full mr-3"}),(0,c.jsx)("h2",{className:"font-semibold text-lg",children:l.username})]})},g=e=>{let{messages:t,userId:s,onDeleteMessage:l}=e;const[a,n]=(0,r.useState)(null),o=(0,r.useRef)(null);return(0,r.useEffect)((()=>{var e;null===(e=o.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})}),[t]),(0,c.jsxs)("div",{className:"flex-1 p-4 bg-gray-50 flex flex-col overflow-y-auto scroll-container",children:[t.length>0?t.map(((e,t)=>{var r;const o=e.attachment_url||e.attachment,i=!!o,d=(null===(r=e.sender)||void 0===r?void 0:r.id)===s;return(0,c.jsxs)("div",{className:`relative max-w-fit ${!i&&d?"bg-blue-100":""} ${i?"":"px-4 py-2"} mb-2 rounded-full ${d?"self-end":"bg-gray-200 self-start"}`,children:[d&&(0,c.jsxs)("div",{className:"absolute -left-6 top-1/2 transform -translate-y-1/2 z-20 group",children:[(0,c.jsxs)("button",{className:"text-gray-500 hover:text-gray-700 focus:outline-none",onClick:()=>(e=>{n((t=>t===e?null:e))})(t),children:[(0,c.jsx)("span",{className:"inline-block w-1.5 h-1.5 bg-gray-500 rounded-full"}),(0,c.jsx)("span",{className:"inline-block w-1.5 h-1.5 bg-gray-500 rounded-full mx-0.5"}),(0,c.jsx)("span",{className:"inline-block w-1.5 h-1.5 bg-gray-500 rounded-full"})]}),a===t&&(0,c.jsx)("div",{className:"absolute right-full top-0 mr-2 mt-0 bg-white border shadow-lg rounded z-50 group-hover:block",onMouseLeave:()=>n(null),onMouseEnter:()=>n(t),children:(0,c.jsx)("button",{onClick:()=>{l(e.id),n(null)},className:"block px-4 py-2 text-sm text-red-500 hover:bg-red-100",children:"Delete"})})]}),i?/\.(jpeg|jpg|png|gif|mp4|webm)$/i.test(o)?(0,c.jsx)("div",{className:"w-40 h-40 rounded-full overflow-hidden bg-gray-200 flex items-center justify-center",children:o.match(/\.(mp4|webm)$/i)?(0,c.jsx)("video",{src:o,controls:!0,className:"object-cover w-full h-full"}):(0,c.jsx)("img",{src:o,alt:"Attachment",className:"object-cover w-full h-full"})}):(0,c.jsx)("a",{href:o,target:"_blank",rel:"noopener noreferrer",className:"text-blue-500 underline",children:"\ud83d\udcce View Attachment"}):(0,c.jsx)("p",{children:e.text||"No content available"})]},t)})):(0,c.jsx)("div",{className:"text-gray-500",children:"No messages yet!"}),(0,c.jsx)("div",{ref:o})]})};s(2394);const h=e=>{let{onEmojiSelect:t}=e;const s=(0,r.useRef)(null);return r.useEffect((()=>{const e=s.current,r=e=>{t&&t(e.detail.unicode)};return e&&e.addEventListener("emoji-click",r),()=>{e&&e.removeEventListener("emoji-click",r)}}),[t]),(0,c.jsx)("emoji-picker",{ref:s})};var x=s(3875),f=s(5874),v=s(4219);const p=e=>{let{onSendMessage:t,currentUser:s,onMessageReceived:l}=e;const[a,n]=(0,r.useState)(""),[o,i]=(0,r.useState)(!1),[d,u]=(0,r.useState)(null),[m,g]=(0,r.useState)(null),p=(0,r.useRef)(null),b=(0,r.useRef)(null);return(0,c.jsxs)("div",{className:"p-4 border-t bg-white flex items-center relative",children:[(0,c.jsx)("button",{onClick:()=>i((e=>!e)),className:"mr-2",children:"\ud83d\ude0a"}),o&&(0,c.jsx)("div",{ref:p,className:"absolute bottom-16 left-0 z-50",children:(0,c.jsx)(h,{onEmojiSelect:e=>n((t=>t+e))})}),(0,c.jsxs)("div",{className:"relative flex w-1/2 items-center",children:[(0,c.jsxs)("div",{className:"flex items-center w-full p-2 border border-gray-300 rounded-lg",children:[d&&(0,c.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,c.jsx)("img",{src:d,alt:"Preview",className:"h-10 w-10 object-cover rounded"}),(0,c.jsx)("button",{onClick:()=>{d&&URL.revokeObjectURL(d),u(null),g(null)},className:"text-red-500 text-sm",children:"\u2715"})]}),(0,c.jsx)("input",{type:"text",value:a,onChange:e=>n(e.target.value),placeholder:"Type your message...",className:"w-full outline-none"})]}),(0,c.jsx)(x.A,{className:"absolute right-10 text-gray-500 cursor-pointer",onClick:()=>b.current.click()}),(0,c.jsx)("input",{type:"file",ref:b,style:{display:"none"},onChange:e=>{const t=e.target.files[0];if(t){if(t.type.startsWith("image/")||t.type.startsWith("video/")){const e=URL.createObjectURL(t);u(e),g(t)}else alert("Please select a valid image or video file.");b.current.value=null}}}),(0,c.jsx)(v.A,{className:"absolute right-2 text-gray-500 cursor-pointer"})]}),(0,c.jsx)("button",{type:"button",className:"ml-3 text-blue-500",onClick:()=>{a.trim()||m?(t(a,m,d),n(""),d&&URL.revokeObjectURL(d),u(null),g(null)):alert("Please enter a message or attach a file.")},children:(0,c.jsx)(f.A,{})})]})},b=e=>{let{conversation:t,user:s}=e;const[l,a]=(0,r.useState)(t.messages||[]),[n,d]=(0,r.useState)(!1),u=(0,r.useRef)(null),h=(0,r.useRef)(null);(0,r.useEffect)((()=>{const e=`ws://localhost:8000/ws/socket-server/${t.id}/`;return u.current=new WebSocket(e),u.current.onopen=()=>{console.log("WebSocket connection established.")},u.current.onmessage=e=>{const t=JSON.parse(e.data);if(console.log("WebSocket message received:",t),"chat"===t.type){if(t.senderId===s.user_id)return;a((e=>[...e,{id:t.id,text:t.message,sender:{username:t.sender},timestamp:(new Date).toISOString()}]))}else if("deleteMessage"===t.type){const e=t.messageId;a((t=>t.filter((t=>t.id!==e))))}else"user_typing"===t.type?t.sender!==s.username&&(d(!0),h.current&&clearTimeout(h.current),h.current=setTimeout((()=>{d(!1)}),3e3)):"user_stopped_typing"===t.type&&t.sender!==s.username&&d(!1)},u.current.onerror=e=>{console.error("WebSocket error:",e)},u.current.onclose=()=>{console.log("WebSocket connection closed.")},()=>{u.current.close(),h.current&&clearTimeout(h.current)}}),[t.id,s.username]);return(0,c.jsxs)("div",{className:"flex flex-col h-screen overflow-y-hidden",children:[(0,c.jsx)(m,{conversation:t}),(0,c.jsx)(g,{messages:l,userId:s.user_id,onDeleteMessage:async e=>{try{a((t=>t.filter((t=>t.id!==e)))),await(async e=>{try{return await o.A.delete(i.C+`/api/messages/${e}/delete/`,{headers:{Authorization:`Bearer ${sessionStorage.getItem("accessToken")}`}}),{messageId:e}}catch(t){throw console.error("Error deleting message:",t),t}})(e),u.current.send(JSON.stringify({type:"deleteMessage",messageId:e}))}catch(t){console.error("Failed to delete message:",t)}}}),n&&(0,c.jsx)("div",{className:"text-gray-500 text-sm p-2",children:"The other user is typing..."}),(0,c.jsx)(p,{onSendMessage:async(e,r,l)=>{const n=new FormData;e.trim()&&n.append("text",e),r&&n.append("attachment",r);const c={id:Date.now(),text:e.trim()||null,sender:{id:s.user_id,username:s.username},timestamp:(new Date).toISOString(),attachment:null,attachmentUrl:l||null};a((e=>[...e,c]));try{const e=(await o.A.post(i.C+`/api/conversations/${t.id}/messages/`,n,{headers:{Authorization:`Bearer ${sessionStorage.getItem("accessToken")}`,"Content-Type":"multipart/form-data"}})).data;u.current.send(JSON.stringify({type:"chat",id:e.id,message:e.text,sender:s.username,senderId:s.user_id}))}catch(d){console.error("Error sending message:",d),a((e=>e.filter((e=>e.id!==c.id))))}},onTyping:()=>{u.current.send(JSON.stringify({type:"user_typing",sender:s.username}))},onStopTyping:()=>{u.current.send(JSON.stringify({type:"user_stopped_typing",sender:s.username}))}})]})};var j=s(4449),y=s(3438),N=s(7392),w=s(2538);const S=function(e){let{children:t,className:s}=e;return(0,c.jsx)("h1",{className:(0,w.cn)("font-alegreyaSans-black text-primary text-4xl",s),children:t})};function k(e){let{title:t,children:s,open:r=!1,setOpen:l,className:a,cypressTag:n,hideClose:o=!1}=e;return(0,c.jsx)("div",{children:(0,c.jsx)(j.A,{open:r,"data-cy":n,onClose:()=>l(!1),"aria-labelledby":"modal-modal-title","aria-describedby":"modal-modal-description",className:"flex justify-center items-center",children:(0,c.jsxs)("div",{className:"relative text-primary",children:[!o&&(0,c.jsx)(N.A,{onClick:()=>l(!1),className:"absolute top-5 right-5 text-pr z-20",children:(0,c.jsx)(y.A,{className:"text-4xl"})}),(0,c.jsxs)("div",{className:(0,w.cn)("over bg-white w-fit min-w-[450px] min-h-5 p-5 max-w-[1200px] m-5 shadow-md overflow-auto tall:max-w-[auto] tall:max-h-[500px]",a),children:[t&&(0,c.jsx)(S,{className:"m-0",children:t}),s]})]})})})}var C=s(324);const _=new(s(2907).QueryClient)({defaultOptions:{queries:{useErrorBoundary:!0,refetchOnWindowFocus:!1,retry:!1}}}),I=async e=>{const t=sessionStorage.getItem("accessToken"),s=await o.A.patch(i.C+"/api/profile/edit/",e,{headers:{Authorization:`Bearer ${t}`}});return console.log(s.data),s.data};var A=s(7332);const D=e=>{let{onImageDrop:t,initialImage:s}=e;const[l,a]=(0,r.useState)(s),[n,o]=(0,r.useState)(!1),[i,d]=(0,r.useState)(!1);return(0,c.jsxs)("div",{className:"relative w-40 h-40 rounded-full overflow-hidden border-4 "+(n?"border-blue-500":"border-gray-400"),onDragOver:e=>{e.preventDefault(),o(!0)},onDragLeave:e=>{e.preventDefault(),o(!1)},onDrop:e=>{e.preventDefault(),o(!1);const s=e.dataTransfer.files[0];if(s&&s.type.startsWith("image/")){const e=URL.createObjectURL(s);a(e),t&&t(s)}else alert("Please drop a valid image file.")},children:[(0,c.jsx)("img",{src:s,alt:"Profile",className:"absolute top-0 left-0 w-full h-full object-cover cursor-pointer",onClick:()=>d(!0)}),n&&(0,c.jsx)("div",{className:"absolute top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center",children:(0,c.jsx)("p",{className:"text-white text-lg font-semibold",children:"Drop Here"})}),(0,c.jsx)("input",{id:"file-input",type:"file",accept:"image/*",className:"hidden",onChange:e=>{const s=e.target.files[0];if(s&&s.type.startsWith("image/")){const e=URL.createObjectURL(s);a(e),t&&t(s)}else alert("Please select a valid image file.")}}),i&&(0,c.jsxs)("div",{className:"fixed top-0 left-0 w-full h-full bg-black bg-opacity-75 flex items-center justify-center z-50",children:[(0,c.jsx)("img",{src:s,alt:"Zoomed",className:"w-auto max-w-full h-auto max-h-full"}),(0,c.jsx)("button",{className:"absolute top-4 right-4 text-white text-xl font-bold",onClick:()=>d(!1),children:"\u2715"})]}),(0,c.jsx)("button",{className:"absolute bottom-2 right-2 bg-blue-500 text-white p-2 rounded-full shadow-md",onClick:()=>{document.getElementById("file-input").click()},children:"\ud83d\udce4"})]})},E=()=>{const[e,t]=(0,r.useState)({}),[s,n]=(0,r.useState)(null),[o,d]=(0,r.useState)(!1),[m,g]=(0,r.useState)(""),[h,x]=(0,r.useState)(null),f=(e=>{let{config:t}=e;return(0,C.n)({mutationKey:["editProfile"],mutationFn:I,onMutate:async e=>{const t=_.getQueryData(["userProfile"]);return _.setQueryData(["userProfile"],(t=>({...t,...e}))),{previousUserProfile:t}},onError:(e,t,s)=>{null!==s&&void 0!==s&&s.previousUserProfile&&_.setQueryData(["userProfile"],s.previousUserProfile)},onSuccess:()=>{_.invalidateQueries(["userProfile"])},...t})})({}),v=(0,a.Zp)(),p=e.profile_image_url?`${i.C}${e.profile_image_url}`:"/default-avatar.png";(0,r.useEffect)((()=>{(0,l.l)(t,(()=>{}),n,v)}),[v]);const j=(0,r.useCallback)((e=>{console.log("Image dropped:",e)}),[]),y=[{label:"Name",value:e.username||"John Doe"},{label:"Date of Birth",value:e.date_of_birth||"Not provided"},{label:"Location",value:e.location||"Not specified"},{label:"Native Language",value:e.native_language||"English"},{label:"Languages Practicing",value:e.languages||"Spanish, French"},{label:"Learning Goal",value:e.learningGoal||"Become fluent for travel"},{label:"Date Joined",value:e.dateJoined||"January 1, 2023"}];return(0,c.jsxs)("div",{className:"flex min-h-screen bg-gray-100",children:[(0,c.jsx)(u,{onSelectConversation:x,activeConversationId:null===h||void 0===h?void 0:h.id}),(0,c.jsx)("div",{className:"flex-1 relative p-6",children:h?(0,c.jsxs)("div",{className:"flex flex-col h-full",children:[(0,c.jsx)("div",{className:"absolute top-4 right-4",children:(0,c.jsx)(N.A,{color:"primary","aria-label":"Back to Profile",onClick:()=>x(null),children:(0,c.jsx)(A.A,{})})}),(0,c.jsx)(b,{conversation:h,user:e})]}):(0,c.jsxs)("div",{className:"flex flex-col items-center space-y-6 w-full",children:[(0,c.jsx)("button",{className:"absolute top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-full hover:bg-red-600 transition",onClick:()=>{sessionStorage.removeItem("accessToken"),v("/login")},children:"Sign Out"}),(0,c.jsx)(D,{onImageDrop:j,initialImage:p}),(0,c.jsx)("button",{className:"bg-blue-500 text-white py-2 px-4 rounded-full hover:bg-blue-600 transition",onClick:()=>d(!0),children:"Edit"}),(0,c.jsxs)("div",{className:"w-full max-w-lg p-6 bg-white rounded-lg shadow-md",children:[y.map(((e,t)=>{let{label:s,value:r}=e;return(0,c.jsxs)("div",{className:"mb-4",children:[(0,c.jsxs)("h2",{className:"text-lg font-semibold text-gray-700",children:[s,":"]}),(0,c.jsx)("p",{className:"text-gray-900",children:r}),t<y.length-1&&(0,c.jsx)("hr",{className:"border-gray-200 mt-2"})]},t)})),s&&(0,c.jsx)("div",{className:"text-red-500 mt-4",children:s})]})]})}),o&&(0,c.jsxs)(k,{open:o,setOpen:d,children:[(0,c.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"Edit Name"}),(0,c.jsx)("input",{type:"text",value:m,onChange:e=>g(e.target.value),className:"w-full p-2 mb-4 border rounded focus:outline-none focus:ring focus:border-blue-300",placeholder:"Enter new Name"}),(0,c.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,c.jsx)("button",{className:"bg-gray-300 text-gray-800 py-1 px-4 rounded hover:bg-gray-400 transition",onClick:()=>d(!1),children:"Close"}),(0,c.jsx)("button",{className:"bg-blue-500 text-white py-1 px-4 rounded hover:bg-blue-600 transition",onClick:async()=>{try{await f.mutateAsync({username:m}),t((e=>({...e,username:m}))),d(!1)}catch(e){n(e.message)}},children:"Save"})]})]})]})}}}]);
//# sourceMappingURL=602.0a2029c8.chunk.js.map